## 1. 业务域分析与微服务划分

**关键设计理念**

1. 业务域驱动划分
   按照订单、配送、定价、财务等业务域来划分微服务，确保高内聚低耦合。每个服务职责清晰，便于独立开发和维护。
2. 事件驱动架构
   通过RocketMQ实现服务间异步解耦，订单状态变更、询价请求、发单事件等都通过消息队列传递，提升系统响应性和可扩展性。
3. 分层架构设计
   * API网关层：统一入口，限流熔断
   * 微服务层：核心业务逻辑
   * 消息队列层：异步解耦
   * 数据存储层：持久化存储

> - [DDD领域驱动设计理论 - 得物技术](https://tech.dewu.com/article?id=113)
> - [领域驱动设计DDD在B端营销系统的实践 - 美团技术团队](https://tech.meituan.com/2017/12/22/ddd-in-practice.html) 
> - [领域驱动设计在互联网业务开发中的实践 - 美团技术团队](https://tech.meituan.com/2024/05/27/ddd-in-business.html)

### 1.1 核心业务域

* 平台接入域（Platform）：上游平台对接
* 订单域（Order）：订单生命周期管理
* 财务域（Finance）：资金结算与对账

合并为：配送调度域（delivery-dispatch）
* 配送域（Delivery）：配送平台对接与管理
* 定价域（Pricing）：动态定价与询价策略
* 策略域（Strategy）：发单策略与路由规则

## 2. 技术架构设计
### 2.1 整体架构图
```text
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  UU溢出单        │    │  顺丰溢出单       │    │  ...溢出单平台   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
         ┌─────────────────────────────────────────────────┐
         │        platform-gateway-service                 │
         │        (平台网关服务)                             │
         └─────────────────────────────────────────────────┘
                                 │
                    ┌─────────────────────────┐
                    │     order-service       │
                    │     (订单服务)           │
                    └─────────────────────────┘
                                 │
                    ┌─────────────────────────┐
                    │ delivery-dispatch       │
                    │ (配送调度服务-核心)        │
                    │ ┌─────────────────────┐ │
                    │ │ 配送平台管理          │ │
                    │ │ 智能询价              │ │
                    │ │ 发单策略              │ │
                    │ │ 配送跟踪              │ │
                    │ └─────────────────────┘ │
                    └─────────────────────────┘
                                 │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  UU跑腿          │    │  闪送            │    │  顺丰/蜂鸟      │
│  平台API         │    │  平台API         │    │  平台API       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```
### 2.2 数据架构设计

**数据库分库分表策略**

- 按业务域分库: order_db、finance_db、delivery_db等 
- 按时间分表: 订单表按月分表 order_202409、order_202410
- 按地域分片: 配送数据按城市分片

## 3. 关键业务流程设计

### 3.1 订单接入流程
```text
上游平台推单 
  ↓
platform-gateway-service (协议转换)
  ↓ (MQ异步)
order-service (订单创建)
  ↓ 
delivery-dispatch-service (一站式处理)
  ├── 平台筛选
  ├── 并发询价  
  ├── 策略评分
  ├── 智能发单
  └── 状态跟踪
  ↓
配送平台接单
```

### 3.2 delivery-dispatch-service 内部流程
```text
接收订单事件
  ↓
platform.Manager (筛选可用平台)
  ↓
pricing.Engine (并发询价)
  ↓
strategy.Engine (策略评分)
  ↓
dispatch.Engine (执行发单)
  ↓
tracker (状态跟踪)

Dispatch Service -> 根据策略类型:
                 -> 顺序发单: 按优先级依次发送
                 -> 并发发单: 同时向多个平台发送
                 -> 价格发单: 按价格排序发送
                 -> 时效发单: 按配送时效发送
```

## 4. 消息队列设计
### 4.1 Topic设计

* order-create-topic：订单创建事件
* order-status-topic：订单状态变更
* pricing-request-topic：询价请求
* dispatch-topic：发单事件
* finance-settlement-topic：财务结算
* notification-topic：通知消息

### 4.2 消费者组设计

* order-processor-group：订单处理消费者组
* finance-processor-group：财务处理消费者组
* notification-group：通知消费者组